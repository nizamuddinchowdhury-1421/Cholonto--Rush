{% extends 'base.html' %}
{% block title %}Checkout - Cholonto--Rush{% endblock %}
{% block content %}
  <h1 class="mb-3">Checkout</h1>
  <div class="row g-4">
    <div class="col-md-7">
      <ul class="list-group mb-3">
        {% for it in items %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ it.service.name }}</strong>
              <div class="small text-muted">Qty {{ it.quantity }} × ৳{{ it.service.base_price }}</div>
            </div>
            <span>₹{{ it.line_total }}</span>
          </li>
        {% empty %}
          <li class="list-group-item">No items in cart.</li>
        {% endfor %}
        <li class="list-group-item d-flex justify-content-between">
          <strong>Total</strong>
          <strong>৳{{ total }}</strong>
        </li>
      </ul>
    </div>
    <div class="col-md-5">
      <form method="post" action="/orders/book/">
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label">Select Service Center</label>
          <select name="center_id" id="centerSelect" class="form-select" required>
            {% for c in centers %}
              <option value="{{ c.id }}">{{ c.name }} — {{ c.address }}</option>
            {% endfor %}
          </select>
        </div>
        <input type="hidden" name="lat" id="latField">
        <input type="hidden" name="lng" id="lngField">
        <button class="btn btn-primary w-100" type="submit">Book Services</button>
      </form>
      <button id="autoNearest" class="btn btn-outline-secondary w-100 mt-2" type="button">Use my nearest center</button>
    </div>
  </div>
{% endblock %}
{% block scripts %}
<script>
  const centers = [
    {% for c in centers %}
      {id: {{ c.id }}, name: `{{ c.name }}`, lat: {{ c.latitude }}, lng: {{ c.longitude }}},
    {% endfor %}
  ];
  function distanceKm(a, b){
    const R=6371;const dLat=(b.lat-a.lat)*Math.PI/180;const dLon=(b.lng-a.lng)*Math.PI/180;
    const la1=a.lat*Math.PI/180, la2=b.lat*Math.PI/180;
    const x=Math.sin(dLat/2)**2+Math.sin(dLon/2)**2*Math.cos(la1)*Math.cos(la2);
    return 2*R*Math.asin(Math.sqrt(x));
  }
  document.getElementById('autoNearest').onclick=()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      const me={lat:pos.coords.latitude,lng:pos.coords.longitude};
      let best=null;let bestD=1e9;
      centers.forEach(c=>{const d=distanceKm(me,{lat:c.lat,lng:c.lng});if(d<bestD){bestD=d;best=c;}});
      document.getElementById('centerSelect').value=best.id;
      document.getElementById('latField').value=me.lat;
      document.getElementById('lngField').value=me.lng;
    });
  };
  // try to capture location immediately as well
  if (navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      document.getElementById('latField').value=pos.coords.latitude;
      document.getElementById('lngField').value=pos.coords.longitude;
    });
  }
</script>
{% endblock %}

