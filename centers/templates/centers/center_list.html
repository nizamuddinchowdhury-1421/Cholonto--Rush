{% extends 'base.html' %}
{% block title %}Service Centers - Cholonto--Rush{% endblock %}
{% block content %}
  <h1 class="mb-3">Service Centers</h1>
  <p class="text-muted">Share location to find nearest center.</p>
  <button id="locateBtn" class="btn btn-primary mb-3">Use my location</button>
  <div id="nearest" class="alert alert-info d-none"></div>
  <ul class="list-group">
    {% for c in centers %}
      <li class="list-group-item">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ c.name }}</strong>
            <div class="small text-muted">{{ c.address }} | {{ c.phone }}</div>
          </div>
          <a class="btn btn-outline-success" href="tel:{{ c.phone }}">Call</a>
        </div>
      </li>
    {% endfor %}
  </ul>
{% endblock %}
{% block scripts %}
<script>
  const centers = [
    {% for c in centers %}
      {id: {{ c.id }}, name: `{{ c.name }}`, lat: {{ c.latitude }}, lng: {{ c.longitude }}, phone: `{{ c.phone }}`},
    {% endfor %}
  ];
  function distanceKm(a, b){
    const R=6371;const dLat=(b.lat-a.lat)*Math.PI/180;const dLon=(b.lng-a.lng)*Math.PI/180;
    const la1=a.lat*Math.PI/180, la2=b.lat*Math.PI/180;
    const x=Math.sin(dLat/2)**2+Math.sin(dLon/2)**2*Math.cos(la1)*Math.cos(la2);
    return 2*R*Math.asin(Math.sqrt(x));
  }
  document.getElementById('locateBtn').onclick=()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      const me={lat:pos.coords.latitude,lng:pos.coords.longitude};
      let best=null;let bestD=1e9;
      centers.forEach(c=>{const d=distanceKm(me,{lat:c.lat,lng:c.lng});if(d<bestD){bestD=d;best=c;}});
      const el=document.getElementById('nearest');
      el.classList.remove('d-none');
      el.innerHTML=`Nearest: <strong>${best.name}</strong> ~ ${bestD.toFixed(1)} km away <a class="btn btn-sm btn-success ms-2" href="tel:${best.phone}">Call</a>`;
    });
  };
</script>
{% endblock %}

